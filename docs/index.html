<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Italienisch Vokabeltrainer</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#84AB8A">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <style>
      :root {
        --clr-sage: #84AB8A;
        --clr-mint: #EBFFF5;
        --clr-teal: #83C9C9;
        --clr-ivory: #FFFFF2;
        --clr-ink: #222222;
      }
      html,body {height:100%}
      body { margin:0; background: var(--clr-ivory); color: var(--clr-ink); font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
      .container { max-width: 1000px; margin: 0 auto; padding: 16px; }
      .btn { border:1px solid #0000; background:#fff; padding:10px 14px; border-radius:12px; cursor:pointer; box-shadow:0 1px 2px rgba(0,0,0,.08)}
      .btn.primary { background: var(--clr-sage); color: white; border-color: var(--clr-sage);}
      .btn.ghost { background: white; border-color: #ddd; }
      .chip { display:inline-block; padding:2px 10px; border-radius:999px; background:var(--clr-mint); border:1px solid #d6f5ea; }
      .card { background:white; border:1px solid #eaeaea; border-radius:20px; box-shadow:0 2px 8px rgba(0,0,0,.04); padding:24px; }
      header { position:sticky; top:0; background:rgba(255,255,255,.8); backdrop-filter: blur(8px); border-bottom:1px solid #eee; }
      nav button { margin-right:8px }
      table { width:100%; border-collapse: collapse; }
      th, td { padding:10px; border-top:1px solid #eee; text-align:left }
      .tabs button.active { background: var(--clr-ink); color:white; border-color: var(--clr-ink);}
      .muted { color:#6b7280 }
      .grid { display:grid; gap:16px }
      .grid-2 { grid-template-columns: repeat(2, minmax(0,1fr)) }
      @media (max-width: 680px) { .grid-2 { grid-template-columns: 1fr } }
      .link { color: var(--clr-sage); text-decoration: none; border-bottom: 1px dashed currentColor }
      .input, select, textarea { padding:10px 12px; border-radius:12px; border:1px solid #ddd; width:100% }
      .bad { background:#fdecec; border-color:#f5b5b5 }
      .good { background:#e7f7ec; border-color:#b7e2c4 }
      .speaker { margin-left:8px; }
    </style>
    <script defer src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script defer src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script defer src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body>
    <header>
      <div class="container" style="display:flex; align-items:center; gap:12px; padding:12px 16px;">
        <div style="width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--clr-sage),var(--clr-teal));display:grid;place-items:center;color:#fff;font-weight:700">IT</div>
        <h1 style="margin:0;font-size:20px;">Italienisch Vokabeltrainer</h1>
        <div style="margin-left:auto" id="due-counter" class="muted"></div>
      </div>
    </header>
    <main class="container">
      <div id="root"></div>
    </main>

    <script type="text/babel">
      const { useState, useEffect, useMemo } = React;

      const LS_KEY = "it-vocab-trainer:v2";
      const DATE_FMT = new Intl.DateTimeFormat(undefined, { dateStyle: "medium", timeStyle: "short" });
      const now = () => Date.now();
      const minutes = (n) => n * 60 * 1000;
      const days = (n) => n * 24 * 60 * 60 * 1000;
      const INTERVALS = [ minutes(10), days(1), days(3), days(7), days(16) ];
      const uid = () => (crypto.randomUUID?.() || Math.random().toString(36).slice(2));
      const norm = (s) => (s || "").toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, "");
      const shuffle = (arr) => arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);
      const clamp = (n,a,b)=>Math.min(Math.max(n,a),b);

      function loadState() { try { return JSON.parse(localStorage.getItem(LS_KEY)||"null") } catch { return null } }
      function saveState(s) { localStorage.setItem(LS_KEY, JSON.stringify(s)) }

      function scheduleNext(card, result) {
        const idx = clamp(card.intervalIndex ?? 0, 0, INTERVALS.length-1);
        let nextIdx = idx; let streak = card.streak ?? 0;
        if (result === "good") { nextIdx = clamp(idx+1,0,INTERVALS.length-1); streak += 1; }
        else { nextIdx = 0; streak = 0; }
        return { ...card, intervalIndex: nextIdx, streak, dueAt: now() + INTERVALS[nextIdx] };
      }

      function speak(text, lang="it-IT") {
        if (!('speechSynthesis' in window)) return;
        const u = new SpeechSynthesisUtterance(text);
        u.lang = lang;
        window.speechSynthesis.speak(u);
      }

      function Tabs({ tab, setTab }) {
        const tabs = [
          ["learn","Lernen"],
          ["list","Vokabeln"],
          ["add","HinzufÃ¼gen"],
          ["settings","Einstellungen"],
        ];
        return (
          <div className="tabs" style={{display:'flex', gap:8, margin:'12px 0 16px'}}>
            {tabs.map(([id,label]) => (
              <button key={id} className={{"btn":true,"active":tab===id}} onClick={()=>setTab(id)}>{label}</button>
            ))}
          </div>
        );
      }

      function LearnView({ items, setItems }) {
        const [mode, setMode] = useState("flashcards");
        const [direction, setDirection] = useState("it-de"); // it-de | de-it
        const [idx, setIdx] = useState(0);
        const [reveal, setReveal] = useState(false);
        const due = useMemo(() => items.filter(i=>!i.suspended && (i.dueAt ?? 0) <= now()), [items]);
        const current = due[Math.min(idx, Math.max(0,due.length-1))];

        useEffect(() => { const el = document.getElementById('due-counter'); if (el) el.textContent = due.length ? ('FÃ¤llig: ' + due.length) : 'Nichts fÃ¤llig'; }, [due.length]);

        if (!current) return <div className="card"><b>ðŸŽ‰ Nichts fÃ¤llig!</b><div className="muted">FÃ¼ge neue Karten hinzu oder komme spÃ¤ter wieder.</div></div>;

        const q = direction === "it-de" ? current.it : current.de;
        const a = direction === "it-de" ? current.de : current.it;

        function mark(res) {
          setItems(prev => prev.map(it => it.id===current.id ? scheduleNext(it, res) : it));
          setReveal(false); setIdx(i=>i+1);
        }

        return (
          <div className="grid">
            <div className="card">
              <div style={{display:'flex', gap:8, alignItems:'center', justifyContent:'space-between'}}>
                <div style={{display:'flex', gap:8, alignItems:'center'}}>
                  <span className="chip">Modus</span>
                  <select value={mode} onChange={e=>setMode(e.target.value)}>
                    <option value="flashcards">Flashcards</option>
                    <option value="mc">Multiple Choice</option>
                    <option value="typing">Tippen</option>
                  </select>
                </div>
                <div style={{display:'flex', gap:8, alignItems:'center'}}>
                  <span className="chip">Richtung</span>
                  <select value={direction} onChange={e=>setDirection(e.target.value)}>
                    <option value="it-de">Italienisch â†’ Deutsch</option>
                    <option value="de-it">Deutsch â†’ Italienisch</option>
                  </select>
                </div>
              </div>
            </div>

            {mode === "flashcards" && (
              <div className="card" style={{textAlign:'center'}}>
                <div className="muted" style={{marginBottom:8}}>{direction === 'it-de' ? 'Frage (IT)' : 'Frage (DE)'} â€“ Intervall: {formatInterval(INTERVALS[current.intervalIndex ?? 0])}</div>
                <div style={{fontSize:32, fontWeight:700}}>{q}</div>
                <button className="btn ghost speaker" onClick={()=>speak(direction==='it-de' ? current.it : current.de, direction==='it-de' ? 'it-IT' : 'de-DE')}>ðŸ”Š</button>
                {reveal && <div style={{marginTop:10, fontSize:22}}><b>Antwort:</b> {a}</div>}
                <div style={{marginTop:14}}>
                  <button className="btn ghost" onClick={()=>setReveal(r=>!r)}>{reveal ? "Vorderseite" : "AuflÃ¶sung zeigen"}</button>
                </div>
                <div style={{display:'flex', gap:8, marginTop:16}}>
                  <button className="btn ghost bad" onClick={()=>mark('again')}>Wiederholen</button>
                  <button className="btn primary good" onClick={()=>mark('good')}>Gewusst</button>
                </div>
              </div>
            )}

            {mode === "mc" && <MultipleChoice current={current} direction={direction} a={a} q={q} items={items} onResult={(res)=>mark(res)} /> }

            {mode === "typing" && <Typing current={current} direction={direction} a={a} q={q} onResult={(res)=>mark(res)} /> }
          </div>
        );
      }

      function MultipleChoice({ current, q, a, items, direction, onResult }) {
        const options = useMemo(() => {
          const pool = shuffle(items.filter(i=>i.id!==current.id)).slice(0,3).map(i => direction==='it-de' ? i.de : i.it);
          return shuffle([a, ...pool]);
        }, [current.id, items, a, direction]);
        const [done, setDone] = useState(false);
        function pick(opt) {
          if (done) return;
          setDone(true);
          onResult(norm(opt)===norm(a) ? 'good' : 'again');
        }
        return (
          <div className="card" style={{textAlign:'center'}}>
            <div className="muted" style={{marginBottom:8}}>Multiple Choice â€“ Frage</div>
            <div style={{fontSize:32,fontWeight:700}}>{q}</div>
            <div style={{display:'grid', gap:8, marginTop:16}}>
              {options.map(opt => (
                <button key={opt} className="btn ghost" onClick={()=>pick(opt)}>{opt}</button>
              ))}
            </div>
          </div>
        );
      }

      function Typing({ q, a, onResult, direction, current }) {
        const [val, setVal] = useState("");
        const [feedback, setFeedback] = useState(null);
        function submit(e) {
          e.preventDefault();
          const ok = norm(val) === norm(a);
          setFeedback(ok ? "Richtig!" : ("Gesucht: " + a));
          onResult(ok ? 'good' : 'again');
        }
        return (
          <form className="card" onSubmit={submit} style={{textAlign:'center'}}>
            <div className="muted" style={{marginBottom:8}}>Tippe die Ãœbersetzung</div>
            <div style={{fontSize:32,fontWeight:700}}>{q}</div>
            <div style={{marginTop:12}}><input className="input" autoFocus value={val} onChange={e=>setVal(e.target.value)} placeholder="Antwort eingeben..." /></div>
            <div style={{display:'flex', gap:8, justifyContent:'center', marginTop:12}}>
              <button className="btn primary" type="submit">PrÃ¼fen</button>
              <button className="btn ghost" type="button" onClick={()=>speak(direction==='it-de' ? current.it : current.de, direction==='it-de' ? 'it-IT' : 'de-DE')}>ðŸ”Š Vorlesen</button>
            </div>
            {feedback && <div style={{marginTop:12}} className={"chip"}>{feedback}</div>}
          </form>
        );
      }

      function AddView({ onAdd }) {
        const [it,setIt] = useState(""); const [de,setDe] = useState(""); const [notes,setNotes]=useState("");
        function submit(e) {
          e.preventDefault();
          if (!it.trim() || !de.trim()) return;
          onAdd({ id: uid(), it: it.trim(), de: de.trim(), notes: notes.trim() || undefined, createdAt: now(), dueAt: now(), intervalIndex:0, streak:0, suspended:false });
          setIt(""); setDe(""); setNotes("");
        }
        return (
          <form onSubmit={submit} className="card">
            <div className="grid grid-2">
              <label>Italienisch<input className="input" value={it} onChange={e=>setIt(e.target.value)} placeholder="ragazzo"/></label>
              <label>Deutsch<input className="input" value={de} onChange={e=>setDe(e.target.value)} placeholder="Junge"/></label>
            </div>
            <label style={{display:'block', marginTop:10}}>Notizen (optional)<input className="input" value={notes} onChange={e=>setNotes(e.target.value)} placeholder="Plural: ragazzi"/></label>
            <div style={{marginTop:12, display:'flex', gap:8}}>
              <button className="btn primary" type="submit">HinzufÃ¼gen</button>
              <button className="btn ghost" type="button" onClick={()=>{setIt("");setDe("");setNotes("");}}>ZurÃ¼cksetzen</button>
            </div>
          </form>
        );
      }

      function ListView({ items, setItems }) {
        const [q,setQ] = useState("");
        const filtered = useMemo(()=>items.filter(i=>(norm(i.it).includes(norm(q)) || norm(i.de).includes(norm(q)))), [q,items]);
        function del(id) { if (confirm("Eintrag lÃ¶schen?")) setItems(prev=>prev.filter(i=>i.id!==id)); }
        function toggle(id) { setItems(prev=>prev.map(i=>i.id===id ? {...i, suspended: !i.suspended} : i)); }
        return (
          <div className="card">
            <div className="grid">
              <input className="input" placeholder="Suchenâ€¦" value={q} onChange={e=>setQ(e.target.value)}/>
              <div className="muted">{filtered.length} / {items.length} Treffer</div>
            </div>
            <div style={{overflowX:'auto', marginTop:8}}>
              <table>
                <thead><tr><th>Italienisch</th><th>Deutsch</th><th>FÃ¤llig</th><th>Streak</th><th>Aktionen</th></tr></thead>
                <tbody>
                  {filtered.map(i => (
                    <tr key={i.id}>
                      <td><b>{i.it}</b></td>
                      <td>{i.de}</td>
                      <td className="muted">{i.dueAt ? DATE_FMT.format(i.dueAt) : "â€“"}</td>
                      <td>{i.streak ?? 0}</td>
                      <td>
                        <button className="btn ghost" onClick={()=>toggle(i.id)}>{i.suspended ? "Reaktivieren" : "Pausieren"}</button>
                        <button className="btn ghost" onClick={()=>del(i.id)}>LÃ¶schen</button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        );
      }

      function SettingsView({ items, setItems, settings, setSettings }) {
        const [importText,setImportText]=useState("");
        function exportData() {
          const blob = new Blob([JSON.stringify({items,settings}, null, 2)], {type:"application/json"});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href=url; a.download='vokabeln.json'; a.click(); URL.revokeObjectURL(url);
        }
        function importData() {
          try { const p = JSON.parse(importText); if (!Array.isArray(p.items)) throw new Error("UngÃ¼ltiges Format");
            setItems(p.items); if (p.settings) setSettings(p.settings); alert("Import ok.");
          } catch(e) { alert("Import fehlgeschlagen: " + (e.message||e)); }
        }
        return (
          <div className="grid">
            <div className="card">
              <h3>Einstellungen</h3>
              <div className="grid grid-2">
                <label>Neue Karten pro Sitzung<input type="number" className="input" value={settings.newPerSession} onChange={e=>setSettings({...settings,newPerSession:Number(e.target.value)})}/></label>
                <label>Max. Wiederholungen pro Sitzung<input type="number" className="input" value={settings.maxReviews} onChange={e=>setSettings({...settings,maxReviews:Number(e.target.value)})}/></label>
              </div>
            </div>
            <div className="card">
              <h3>Daten</h3>
              <div style={{display:'flex', gap:8, flexWrap:'wrap'}}>
                <button className="btn ghost" onClick={exportData}>Export als JSON</button>
                <button className="btn ghost" onClick={()=>{ if (confirm('Alle Daten lÃ¶schen?')) setItems([]) }}>Alles lÃ¶schen</button>
              </div>
              <div style={{marginTop:10}}>
                <label>JSON importieren</label>
                <textarea className="input" rows="6" value={importText} onChange={e=>setImportText(e.target.value)} placeholder='{"items":[{"it":"ciao","de":"hallo"}], "settings":{}}'></textarea>
                <button className="btn primary" onClick={importData}>Import starten</button>
              </div>
            </div>
          </div>
        );
      }

      function defaultSettings() { return { newPerSession: 10, maxReviews: 100 }; }
      function demoSeed() {
        const t = now(); const m = (it,de,notes)=>({id:uid(),it,de,notes,createdAt:t,dueAt:t,intervalIndex:0,streak:0,suspended:false});
        return [ m("ciao","hallo; tschÃ¼ss","begrÃ¼ssung"), m("grazie","danke"), m("per favore","bitte"), m("come stai?","wie geht's?"), m("acqua","Wasser"), m("pane","Brot"), m("vino","Wein") ];
      }

      function App() {
        const [tab,setTab] = useState("learn");
        const [items,setItems] = useState(() => loadState()?.items || demoSeed());
        const [settings,setSettings] = useState(() => loadState()?.settings || defaultSettings());
        useEffect(()=>saveState({items,settings}),[items,settings]);
        return (
          <div className="grid">
            <Tabs tab={tab} setTab={setTab}/>
            {tab==='learn' && <LearnView items={items} setItems={setItems}/>}
            {tab==='list' && <ListView items={items} setItems={setItems}/>}
            {tab==='add' && <AddView onAdd={(i)=>setItems(p=>[i,...p])}/>}
            {tab==='settings' && <SettingsView items={items} setItems={setItems} settings={settings} setSettings={setSettings}/>}
            <div className="muted">Speicherung lokal im Browser. FÃ¼r Backups: Einstellungen â†’ Export.</div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App/>);

      if ('serviceWorker' in navigator) { window.addEventListener('load', () => navigator.serviceWorker.register('service-worker.js').catch(()=>{})); }
      function formatInterval(ms) { if (ms < 3600000) return Math.round(ms/60000)+' min'; if (ms < 86400000) return Math.round(ms/3600000)+' h'; return Math.round(ms/86400000)+' d'; }
    </script>
  </body>
</html>
